#!/bin/bash

USAGE=$(cat <<EOF
Usage: kube <Command> <[User@]Hostname> [Args]
       kube <Command> help

Commands
    tools[-<ubuntu|centos>]
    node
    user
    pki
EOF
)

function main {
    case "$1 $2" in
        "$1 help")
            local UNIT="$1"
            "$(workdir)/kube-${UNIT}"
        ;;
        "pki $2")
            local FROM="$2"
            local TO="$3"
            "$(workdir)/kube-pki" "${FROM}" "${TO}"
        ;;
        "make $2")
            shift
            "$(workdir)/kube-make" "$@"
        ;;
        "$1 $2")
            local UNIT="$1"
            local TARGET="$2"
            shift 2

            if [ -z "${UNIT}" ] || \
               [ -z "${TARGET}" ]; then usage; fi

            ssh "${TARGET}" bash -s "$@" < "$(workdir)/kube-${UNIT}"
        ;;
        *) usage ;;
    esac
}

function workdir {
    dirname "$0"
}

function usage {
    >&2 echo "${USAGE}"
    exit 2
}

main "$@"
